---
title: "Mid-Cayman Rise biomass analysis"
author: "Sarah Hu"
date: "2/3/2021"
output: 
  html_document:
    number_sections: true
    theme: spacelab
    highlight: monochrome
    collapsed: false
    toc: true
    toc_depth: 4
    toc_float: true

knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

To do:
1. Review all calculations below. Clean up and end with primary data from MCR and options to include Gorda Ridge, etc.
2. Import objects from ASV analysis for comparison? or export table to inclue in ASV analysis.


# Microbial eukaryotes at Mid-Cayman Rise

_Background_
* Summary of cruise operations

* Summary of data below

* Current status (July 2022)

## Data availability


## Set up working environment
GitHub repo hosts all raw data to reproduce analysis and results. See ```input-data``` or clone the repo.

```{r Library loading, message=FALSE}
library(tidyverse); library(cowplot); library(broom)
```


# Protistan cell concentration
Import eukaryotic cell count data from grazing experiments. In this section, we will calculate cells per ml from raw counts (Field of view, etc.) and use to estimate protist cell concentration. These will be used below in grazing experiment calculations.

```{r Import raw euk countdata}
counts <- read.delim("input-data/euk-counts-compiled.txt", 
                     blank.lines.skip = FALSE,
                     na.strings = c("", "NA"),
                     stringsAsFactors = FALSE) # Import
counts[is.na(counts)] <- 0 # Change blanks to zeroes
```

Raw data table collected during microscopy count process. Below code reviews the structure of this raw data and updates column headers to be more 'R' friendly.
```{r Format for R}
colnames(counts) <- c("DATE", "SAMPLE", "EXPID", "VOL", "MAG", "FOV", "nanoNoFLP", "microNoFLP", "nanoFLP", "microFLP", "NOTES", "DateCompiled"); colnames(counts)
# Column 9 and 10 list the total number of FLP inside each, so # of occurences

# Notes if count was not countable
# unique(counts$NOTES)
head(counts)
```

> To count occurrence and number of FLP ingested by eukaryotic cells, the number of FLPs ingested was tallied and comma separated for multiple eukaryotic cells with FLP. These values need to separated and counted as 1 eukaryotic cell each, but retain the number of FLP per cell.

Parse raw microscopy count data.
```{r Separate comma delim FLP counts, tidy=FALSE}
counts_occur <- counts %>%
  # remove incomplete
  filter(NOTES != "Not countable") %>% 
  # Count number of euk cells observed with FLPs (ex. if "1,2", 'occur' will = 2)
  mutate(nanoFLP_occur = as.numeric(str_count(nanoFLP, "[1-9]\\d*")), 
         microFLP_occur = as.numeric(str_count(microFLP, "[1-9]\\d*")),
         # Add number of euk cells with FLPs to those without for total number of euk cells
         nanoTOTAL = as.numeric(nanoNoFLP) + nanoFLP_occur, 
         microTOTAL = as.numeric(microNoFLP) + microFLP_occur,
         euksTOTAL = nanoTOTAL + microTOTAL) %>%
      data.frame

# unique(counts$nanoFLP)
# unique(counts_occur$nanoFLP_occur)
```

## Calculate cells per ml (euk)
Input data are the raw microscopy counts by FOV. Code below calculations cells/ml based on these values. Additionaly, variance and standard deviation are also calculated. Eukaryotic cells were also classified by size, where micro equates to >20um and nano is <20um. All counts were done at 100x magnification, confirm this: 
```{r QC}
unique(counts_occur$MAG)
# head(counts_occur)
```

Calculate cell concentration (cells/ml).
```{r Calculate cell concentration}
counts_cellsml_all <- counts_occur %>%
  group_by(SAMPLE, EXPID, VOL) %>% #Calculate averages by sample
  summarise(totalFOV = n(), # Count total FOV counted
            nanoAvg = sum(nanoTOTAL)/totalFOV, #Average per FOV
            nanoVar = var(nanoTOTAL), #Variance
            nanoSd = (2*(sqrt(nanoVar))), #Standard deviation
            microAvg = sum(microTOTAL)/totalFOV, ## Repeat for microeuks
            microVar = var(microTOTAL), 
            microSd = (2*(sqrt(microVar))), 
            euksAvg = sum(euksTOTAL)/totalFOV, ## Repeat for total cell count
            euksVar = var(euksTOTAL), 
            euksSd = (2*(sqrt(euksVar))), 
            .groups = 'drop_last') %>%
  # Calculate cells/ml based on magnification (at x100, 0.01 is vol of grid), volume filtered (VOL), dilution factor (0.9), and area of counting grid (for Huber lab scope, it is 283.385):
  mutate(nanoCONC = ((nanoAvg * 283.385)/(VOL * 0.01 * 0.9)),
         microCONC = ((microAvg * 283.385)/(VOL * 0.01 * 0.9)),
         eukCONC = ((euksAvg * 283.385)/(VOL * 0.01 * 0.9))
         ) %>%
  # left_join(expmeta) %>%
  separate(SAMPLE, c("Site", "Name"), sep = "-", remove = FALSE) %>%
  separate(EXPID, c("TimePoint", "Replicate"), sep = "-", remove = FALSE) %>%
  data.frame
```

> Replicates belong to the same experiment for either Bag or IGT incubation. Below, modify these names and label new column with bag or igt. And create an average across replicates.

Average cells/ml across replicates, pivot to long format
```{r Average across replicates}
counts_cellsml_avg <- counts_cellsml_all %>%
  select(Site, Name, TimePoint, Replicate, nanoCONC, microCONC, eukCONC) %>%
  mutate(EXP_TYPE = case_when(
    grepl("IGT", Replicate) ~ "IGT",
    grepl("Rep", Replicate) ~ "Bag"
  )) %>%
  mutate(IGT_REP = case_when(
    EXP_TYPE == "IGT" ~ Replicate,
    EXP_TYPE == "Bag" ~ "Bag")) %>%
  select(-Replicate) %>%
  pivot_longer(cols = ends_with("CONC"), names_to = "VARIABLE", values_to = "CONCENTRATION") %>%
  group_by(Site, Name, TimePoint, EXP_TYPE, IGT_REP, VARIABLE) %>%
  # Calculate mean, variance, SD, min, and max
  summarise(MEAN = mean(CONCENTRATION),
            VAR = var(CONCENTRATION),
            SD = sd(CONCENTRATION),
            SEM =(sd(CONCENTRATION)/sqrt(length(CONCENTRATION))),
            MIN = min(CONCENTRATION),
            MAX = max(CONCENTRATION),
            .groups = 'drop_last') %>%
  data.frame
head(counts_cellsml_avg)
# View(counts_cellsml_avg)
# NOTES on calculations:
# VAR = takes the sum of the squares of each value's deviation from the mean and divides by the number of such values minus one. This differs from the calculation of variance across an entire population in that the latter divides by the size of the dataset without subtracting one.
# SD = standard deviation of all values
# SEM = standard deviation of sampling distribution; standard deviation divided by the square root of the sample size.
```

```{r Check working data frames}
# Euk cell counts, all and averaged
# head(counts_cellsml_all)
# head(counts_cellsml_avg)
# save(counts_cellsml_all, counts_cellsml_avg, file = "raw-avg-eukcount.RData")
```

Parse experiment type information
```{r Include experiment type column}
# Convert to long format and add column that reports IGT vs bag experiment
plot_euk_conc <- counts_cellsml_all %>%
  select(Site, Name, TimePoint, Replicate, ends_with("CONC")) %>%
  mutate(EXP_TYPE = case_when(
    grepl("IGT", Replicate) ~ "IGT",
    grepl("Rep", Replicate) ~ "Bag"
  )) %>%
  pivot_longer(cols = ends_with("CONC"), names_to = "VARIABLE", values_to = "CONCENTRATION") %>%
  data.frame
```

```{r Factor cell count data}
# head(plot_euk_conc)
unique(plot_euk_conc$Name)
vent_ids <- c("BSW","Plume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole")
vent_fullname <- c("Background","Plume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole")
site_ids <- c("VD", "Piccard")
site_fullname <- c("Von Damm", "Piccard")
plot_euk_conc$SiteOrder <- factor(plot_euk_conc$Site, levels = site_ids, labels = site_fullname)
plot_euk_conc$NameOrder <- factor(plot_euk_conc$Name, levels = vent_ids, labels = vent_fullname)
```

## Plot eukaryote cells per ml

Box plot to report all eukaryote cell counts.
```{r plot all euk counts, tidy=FALSE, fig.height=4, fig.width=6}
# Code for plot
conc_boxplot <- ggplot(plot_euk_conc, aes(x = NameOrder, 
                                          y = CONCENTRATION, 
                                          group = NameOrder,
                                          fill = VARIABLE,
                                          shape = EXP_TYPE)) +
    geom_boxplot() + 
    # Do not color by time point
    geom_jitter(color = "black", size = 2, aes(fill = VARIABLE,
                                          shape = EXP_TYPE)) +
    scale_shape_manual(values = c(21,24)) +
    scale_fill_manual(values = c("#e7298a", "#fcbba1", "#c6dbef")) +
    coord_flip() +
    scale_y_log10() +
    # scale_y_log10(limits = c(10,1000), expand = c(0, 0)) +
    facet_grid(SiteOrder ~ EXP_TYPE, space = "free", scale = "free") +
    theme_bw() + 
  theme(axis.text.x = element_text(angle = 0, h = 1, vjust = 1),
        strip.background = element_blank(),
        legend.position = "right",
        legend.title = element_blank()) +
    labs(x = "", y = bquote("Eukaryote cells "~mL^-1),
         title = "Distribution of all eukaryotic cell counts")
```
Eukaryote cell concentration (cells/ml) are lower in the background and plume samples compared to vent sites. ~300 cells/ml in background and plume compared to ~1000 cells per ml at the vent sites. These values are also consistent between each vent site (Von Damm and Piccard) and between Bag and IGT samples. 

> Boxplot represents the median (line in box) and the 1st and 3rd quartiles in the lower and upper hinges, respectively (25th and 75th percentiles). Black data points are outliers from the boxplot. Upper and lower whiskers represent the 1.5 * interquartile ranges. Pink data points are the values contributing to the boxplot (individial counts across replicates and time points.)

```{r Plot all time point euk concentration, fig.height=5, fig.width=7}
conc_boxplot
```

> eukCONC is the sum of micro and nano.
Because there was a discrepency between the micro and nano cell counts, we plan to combine for most of the analysis.
Here we show that the cell concentration across replicate samples was similar throughout experiments. And that the bag versus IGT experiment results were within range of one another. 


Subset to plot from T0 only.
```{r Isolate T0 only to plot, tidy=FALSE}
vent_ids <- c("BSW","Plume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole")
vent_fullname <- c("Background","Plume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole")

plot_euk_format <- plot_euk_conc %>%
  filter(TimePoint == "T0" & (VARIABLE == "eukCONC")) %>%
  group_by(SiteOrder, NameOrder, TimePoint, EXP_TYPE, VARIABLE) %>%
  summarise(avg_conc = mean(CONCENTRATION),
            SEM_conc = (sd(CONCENTRATION)/sqrt(length(CONCENTRATION))),
            .groups = "rowwise") %>%
  unite(EXPERIMENT, SiteOrder, NameOrder, EXP_TYPE, remove = FALSE) %>%
  data.frame

# Factor
plot_euk_format$Site_Order <- factor(plot_euk_format$SiteOrder, levels = site_fullname, labels = site_fullname)

# View(plot_euk_format)
euk_plot <- ggplot(plot_euk_format, aes(x = NameOrder, y = avg_conc, fill = Site_Order)) +
  geom_errorbar(aes(ymax = (avg_conc + SEM_conc), ymin = (avg_conc - SEM_conc)), width = 0.2) +
  geom_point(aes(fill = Site_Order), color = "black", stat = "identity", size = 3, shape = 23) +
  facet_grid(.~ Site_Order, space = "free", scales = "free") +
  scale_fill_manual(values = c("#1c9099", "#de2d26")) +
  theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
           panel.background = element_blank(), 
           axis.line = element_line(colour = "black"), 
           axis.text.x = element_text(color="black", size = 12, 
                                      angle = 45, hjust = 1, vjust = 1), 
           axis.text.y = element_text(color="black", size = 12),
           axis.title =element_text(color="black", size = 12),
           axis.ticks = element_line(),
           strip.text =element_blank(), legend.title = element_blank()) +
  labs(x = "", y = bquote("Eukaryote cells "~mL^-1),
       title = "")
```

```{r euk concentration by sample, fig.height=4, fig.width=6}
euk_plot
```
Summary of findings from eukaryote cell concentration.
```{r Summary of euk findings}
# head(plot_euk_format)

plot_euk_format %>% 
  type.convert(as.is = TRUE) %>%
  filter(VARIABLE == "eukCONC") %>% 
  mutate(SAMPLE_TYPE = case_when(
    NameOrder == "Background" ~ "Background",
    NameOrder == "Plume" ~ "Plume",
    TRUE ~ SiteOrder
  )) %>%
  group_by(SAMPLE_TYPE) %>% 
  summarise(MEAN_cellml = format(mean(avg_conc), scientific = T),
           min_cellml = format(min(avg_conc), scientific = T),
           max_cellml = format(max(avg_conc), scientific = T),
           num = n())
```


# Prokaryote cell concentration
Import counts from DAPI counts of bacteria and archaea.

```{r import and set up prokaryote DAPI count data, message=FALSE}
prok <- read.delim("input-data/prokINSITU-counts-compiled.txt")
# head(prok)
# unique(prok$CELLML)
insitu_proks <- prok %>% 
  filter(CELLML != "not countable") %>% 
  separate(SAMPLE, c("Site", "Name"), sep = "-", remove = FALSE) %>% 
  group_by(SAMPLE, Site, Name) %>% 
  summarise(MEAN = mean(as.numeric(CELLML)),
            SD = sd(CELLML),
            SEM = (sd(CELLML)/sqrt(length(CELLML))),
            .groups = "rowwise") %>% 
  data.frame
# head(insitu_proks)
# View(insitu_proks)
```


## Microscopy cells per ml (prok)

Plot in situ prokaryote values. Average across dives where applicable.
```{r Plot prokaryote amounts, tidy=FALSE}
insitu_proks$Name_order <- factor(insitu_proks$Name, levels = c("BSW", "Plume", "Quakeplume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole", "HotChimlet1", "ShrimpGulley", "SouthofHotChimlet", "SouthofLungSnack", "ArrowLoop", "Bartizan", "Rav1"), labels = c("Background","Plume", "Quakeplume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole", "Hot Chimlet #1", "Shrimp Gulley", "South of Hot Chimlet", "South of LungSnack", "Arrow Loop", "Bartizan", "Ravelin #1"))

site_ids <- c("VD", "Piccard")
site_fullname <- c("Von Damm", "Piccard")

insitu_proks$Site_order <- factor(insitu_proks$Site, levels = site_ids, labels = site_fullname)

# unique(insitu_proks$Name)

prok_plot <- ggplot(insitu_proks, aes(x = Name_order, y = MEAN)) +
  geom_errorbar(aes(ymax = (MEAN + SEM), ymin = (MEAN - SEM)), width = 0.2) +
  geom_point(stat = "identity", shape = 23, aes(fill = Site), size = 3) +
  facet_grid(.~ Site_order, space = "free", scales = "free") +
  scale_fill_manual(values = c("#de2d26", "#1c9099")) +
  labs(y = bquote("Prokaryote cells "~mL^-1), x = "", title = "") +
  scale_y_log10() +
  theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
           panel.background = element_blank(), 
           axis.line = element_line(colour = "black"), 
           axis.text.x = element_text(color="black", size = 12, 
                                      angle = 45, hjust = 1, vjust = 1), 
           axis.text.y = element_text(color="black", size = 12),
           axis.title =element_text(color="black", size = 12),
           axis.ticks = element_line(),
           strip.text =element_blank(), legend.title = element_blank())
```

```{r prokaryote concentration by sample, fig.height=4, fig.width=6}
prok_plot
```

Summary of findings from prokaryote cell counts.
```{r}
insitu_proks %>% 
  filter(Name != "Quakeplume") %>% 
  mutate(SAMPLE_TYPE = case_when(
    Name == "BSW" ~ "Background",
    Name == "Plume" ~ "Plume",
    TRUE ~ Site
  )) %>% 
  group_by(SAMPLE_TYPE) %>% 
  summarise(MEAN_cellml = format(mean(MEAN), scientific = T),
           min_cellml = format(min(MEAN), scientific = T),
           max_cellml = format(max(MEAN), scientific = T),
           num = n())

```


## Comparison with previous MCR
Compare _in situ_ prokaryote cell counts from 2020 to previous years

```{r Import previous cell ml data}
prok_prev <- read.csv("input-data/cellcount_previousyr.csv")
# View(prok_prev)
# head(prok_prev)
prok_prev_formatted <- prok_prev %>% 
  mutate(VENTSITE = case_when(
    grepl("Piccard", Site) ~ "Piccard",
    grepl("Von Damm", Site) ~ "VD"
  )) %>% 
  filter(!is.na(YEAR)) %>% #QC of 
  # filter(cells_ml != "NC") %>% 
  # filter(cells_ml != "") %>% 
  # filter(cells_ml != "no data") %>% 
  type.convert(as.is = TRUE, numerals = "no.loss") %>%
  select(YEAR, VENTSITE, NAME = Name, REP=Replicate, CELLML = cells_ml, ORIGSAMPLE = Orig_vent_site_ID, ID_number, Origin)

# str(prok_prev_formatted)
# View(prok_prev_formatted)
# unique(prok_prev_formatted$VENTSITE)
```


```{r Import 2020 data}
# Re-import 2020
prok <- read.delim("input-data/prokINSITU-counts-compiled.txt")
# View(prok)
proks_allyrs <- prok %>% 
  separate(SAMPLE, c("VENTSITE", "NAME"), sep = "-", remove = FALSE) %>% 
  mutate(YEAR = 2020) %>%
  select(YEAR, VENTSITE, NAME, REP, CELLML, ORIGSAMPLE = BAC) %>% 
  bind_rows(prok_prev_formatted %>% select(-ID_number, -Origin)) %>% 
  type.convert(as.is = TRUE) %>%
  # Remove not countable or not data samples:
  filter(CELLML != "NC") %>%
  filter(CELLML != "") %>%
  filter(CELLML != "no data") %>%
  filter(CELLML != "not countable") %>% 
  data.frame

# View(proks_allyrs)
# View(as.data.frame(unique(proks_allyrs$NAME)))

vent_order <- c("BSW","Plume","Quakeplume","NearsummitBeebee","MainOrifice","NearMainOrifice","Rav1","HotChimlet1","HotChimlet","SouthofHotChimlet","NearHotChimlet","HotCracks1","HotCracks2","ShrimpHole","ShrimpHole(X18)","X18","X19","SouthofLungSnack","TwinPeaks","OMT","WhiteCastle","GingerCastle","ArrowLoop","Bartizan","LotsOShrimp","MustardStand","ShrimpButtery","ShrimpCanyon","ShrimpGulley","Shrimpocalypse","ShrimpVegas")
vent_names <- c("Background","Plume","Quakeplume","Near summit Beebee Vents Mound","Main Orifice","Near Main Orifice","Ravelin #1","Hot Chimlet #1","Hot Chimlet","South of Hot Chimlet","Near Hot Chimlet","Hot Cracks #1","Hot Cracks #2","Shrimp Hole","Shrimp Hole (X-18)","X-18","X-19","South of Lung Snack","Twin Peaks","Old Man Tree","White Castle","Ginger Castle","Arrow Loop","Bartizan","Lots O Shrimp","Mustard Stand","Shrimp Buttery","Shrimp Canyon","Shrimp Gulley","Shrimpocalypse","Shrimp Vegas")
proks_allyrs$NAME_ORDER <- factor(proks_allyrs$NAME, levels = vent_order, labels = vent_names)
proks_allyrs$VENTSITE_ORDER <- factor(proks_allyrs$VENTSITE, levels = c("Piccard", "VD"), labels = c("Piccard", "Von Damm"))
```

```{r Plot cell counts by year, tidy=FALSE, fig.height=8, fig.width=7}
# pdf("compare-across-yr-cellcount-04052021.pdf", h = 8, w = 7)
ggplot(proks_allyrs, aes(x = NAME_ORDER, y = as.numeric(CELLML), fill = factor(YEAR), shape = VENTSITE_ORDER)) +
  geom_point(stat = "identity", aes(fill = factor(YEAR)), size = 3) +
  scale_shape_manual(values = c(21,23)) +
  coord_flip() +
  facet_grid(VENTSITE_ORDER ~ ., space = "free", scales = "free") +
  scale_y_log10() +
  scale_fill_manual(values = c("#1c9099", "#ffeda0", "#fc4e2a")) +
  theme_linedraw() +
  theme(axis.text = element_text(color = "black", size = 10),
        strip.background = element_blank(),
        strip.text.y = element_text(color = "black", size = 11, hjust = 0, vjust = 1),
        legend.title = element_blank(),
        legend.position = "bottom",
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey")) +
  labs(y = bquote("Cells "~mL^-1), x = "") +
  guides(fill=guide_legend(override.aes=list(shape=22)))
# dev.off()
```

Generate complete table with all cell count data
```{r Output to share}
# head(prok)
proks_allyrs_OUTPUT <- prok %>%
  separate(SAMPLE, c("VENTSITE", "NAME"), sep = "-", remove = FALSE) %>% 
  mutate(YEAR = 2020,
         Origin = "") %>%
  mutate(VENTSITE = case_when(
    VENTSITE == "VD" ~ "Von Damm",
    TRUE ~ VENTSITE
  )) %>% 
  separate(BAC, c("ORIGSAMPLE", "ID_number"), sep = " ") %>% 
  select(YEAR, VENTSITE, NAME, REP, CELLML, ORIGSAMPLE, ID_number, Origin) %>%
  bind_rows(prok_prev_formatted) %>%
  data.frame
# View(proks_allyrs_OUTPUT)
# write_delim(proks_allyrs_OUTPUT, path = "input-data/cell-counts-MCR-multiyr.txt", delim = "\t")
```


# Determine grazing effect

Calculate FLP per eukaryotic cell over time. Goal is to make these calculations and then determine best fit line. Slope of best fit line is the grazing rate. Need to take into account euk cells with FLPs and then the euk cells withOUT FLPs, these will be zeroes to take into account for FLPs/euk averages.

Retain previously generated dataframes:
```{r View and check previous data frames}
# save(counts_cellsml_all, counts_cellsml_avg, counts_occur, file = "MCR-cellcount-dfs")
load("MCR-cellcount-dfs", verbose = TRUE)
# Euk cell counts, all and averaged
# head(counts_cellsml_all)
# head(counts_cellsml_avg)
# head(counts_occur)
```

Show concentration of euk cells per ml over time

```{r Calculate average cellsml, tidy=FALSE}
# head(counts_cellsml_avg)
vent_ids <- c("BSW","Plume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole")
vent_fullname <- c("Background","Plume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole")
site_ids <- c("VD", "Piccard")
site_fullname <- c("Von Damm", "Piccard")

counts_cellsml_avg$SiteOrder <- factor(counts_cellsml_avg$Site, levels = site_ids, labels = site_fullname)
counts_cellsml_avg$NameOrder <- factor(counts_cellsml_avg$Name, levels = vent_ids, labels = vent_fullname)

# Plot trend line of euk cell count for all experiments
counts_cellsml_avg %>%
  filter(VARIABLE == "eukCONC") %>%
  unite("Experiment", NameOrder, IGT_REP, sep = "-", remove = FALSE) %>%
  ggplot(aes(x = TimePoint, y = MEAN, shape = EXP_TYPE, fill = NameOrder)) +
    geom_path(aes(group = Experiment)) +
    # geom_errorbar(aes(ymax = (MEAN + SD), ymin = (MEAN - SD)), width = 0.2) +
    geom_errorbar(aes(ymax = (MEAN + SEM), ymin = (MEAN - SEM)), width = 0.2) +
    geom_point(stat = "identity", size = 2, aes(shape = EXP_TYPE)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_brewer(palette = "Paired") +
    scale_y_log10() +
    facet_wrap(SiteOrder ~ EXP_TYPE, scales = "free") +
    theme_classic() + theme(strip.background = element_blank(), 
                            legend.title = element_blank(),
                            title = element_text(size = 7, face = "bold"),
                            axis.title = element_text(size = 9)) +
    labs(title = "Total euk cell counts for each experiment", y = bquote("Average eukaryote cells "~mL^-1), x = "Time point") +
  guides(fill=guide_legend(override.aes=list(shape=21)))
```
## Determine FLP per euk
Isolate the euk cell counts with FLPs, these are comma separated and must be separated into rows. Using ```counts_occur``` data frame from above.

```{r Isolate rows}
# Select nano and micro counts with FLPs
counts_sepflp <- counts_occur %>% 
  filter(!NOTES == "Discard") %>% 
  filter(!(NOTES == "DTAF stain prevented counts of FLP, Euks only")) %>%
  select(DATE, SAMPLE, EXPID, VOL, MAG, FOV, nanoFLP, microFLP) %>%
  # Inputs that are comma separated will be split into a new row
  separate_rows(microFLP, sep = ",", convert = TRUE) %>%
  separate_rows(nanoFLP, sep = ",", convert = TRUE) %>%
  # Replace NAs with zeroes
  replace_na(list(microFLP = 0, nanoFLP = 0)) %>% 
  data.frame

## Check, see FOV 23, separated into rows.
# View(counts_sepflp %>%
# filter(SAMPLE == "VD-Rav2" & EXPID == "T10-Rep1"))
# View(counts_occur %>%
# filter(SAMPLE == "VD-Rav2" & EXPID == "T10-Rep1"))
```

Subset counts that are greater than 0, so only euk cells observed to have FLPs. Create new column that calculates FLP per Euk - by dividing by 1.
```{r Subset and calc FLP per euk}
counts_flp <- counts_sepflp %>%
  select(SAMPLE, EXPID, nano_size = nanoFLP, micro_size = microFLP) %>%
  pivot_longer(cols = ends_with("_size"), names_to = "SizeFrac", values_to = "num_of_FLP") %>%
  filter(num_of_FLP > 0) %>%
  separate(SAMPLE, c("Site", "Name"), sep = "-", remove = FALSE) %>%
  separate(EXPID, c("TimePoint", "Replicate"), sep = "-", remove = FALSE) %>%
  mutate(EXP_TYPE = case_when(
    grepl("IGT", Replicate) ~ "IGT",
    grepl("Rep", Replicate) ~ "Bag"
  )) %>%
  mutate(IGT_REP = case_when(
    EXP_TYPE == "IGT" ~ Replicate,
    EXP_TYPE == "Bag" ~ "Bag")) %>%
  group_by(SAMPLE, EXPID, EXP_TYPE, IGT_REP, SizeFrac) %>%
  summarise(total_FLP = sum(num_of_FLP),
            total_euks_wflp = n(),
            .groups = "rowwise") %>%
  data.frame
```
OUTPUT COLUMNS:
(1) total_FLP = sum of FLPs found inside a euk cell
(2) total_euks_wflp = number of euks counted with ingested FLP

Repeat above operation for euk cells without any FLP. Here, subset total number of observations where there was a euk cell without FLP. These need to be counted as euk cell without an FLP.

> Below code repeats process and compiles with other FLP/euk cell data.

```{r Repeat for non-FLP euk cells and combine}
counts_flp_compiled <- counts_occur %>% 
  filter(!(NOTES == "Discard")) %>% #Discard bad counts
  filter(!(NOTES == "DTAF stain prevented counts of FLP, Euks only")) %>%
  type.convert(as.is = TRUE) %>% #modify str() for columns
  select(SAMPLE, EXPID, nano_size = nanoNoFLP, micro_size = microNoFLP) %>% #select non flp
  pivot_longer(cols = ends_with("_size"), names_to = "SizeFrac", values_to = "num_of_euks") %>%
  separate(SAMPLE, c("Site", "Name"), sep = "-", remove = FALSE) %>%
  separate(EXPID, c("TimePoint", "Replicate"), sep = "-", remove = FALSE) %>%
  mutate(EXP_TYPE = case_when(
    grepl("IGT", Replicate) ~ "IGT",
    grepl("Rep", Replicate) ~ "Bag"
  )) %>%
  mutate(IGT_REP = case_when(
    EXP_TYPE == "IGT" ~ Replicate,
    EXP_TYPE == "Bag" ~ "Bag")) %>% 
  # filter(num_of_euks > 0) %>% # Remove observed zero counts
  group_by(SAMPLE, EXPID, EXP_TYPE, IGT_REP, SizeFrac) %>%
  summarise(total_euks_noFLP = sum(num_of_euks),
            .groups = "rowwise") %>%
  # Join with FLP count information
  ## SAMPLE, EXPID, EXPTYPE, IGTREP, and SizeFrac variables should match
  left_join(counts_flp) %>% # Join with the counts of FLP per euk cell
  replace_na(list(total_FLP = 0, total_euks_wflp = 0)) %>% #Replace NAs with zero
  data.frame

## Check data frames
# View(counts_flp_compiled)
# View(counts_occur)
# (filter(counts_flp_compiled, SAMPLE == "VD-X18", EXPID == "T40-Rep2"))
# (filter(counts_flp_compiled, SAMPLE == "Piccard-Plume", EXPID == "T10-Rep1"))
# head(counts_flp_compiled)
```

Extract total euk value by adding across nano and micro, then combine back with nano and micro counts.

```{r Extract total euk cell count values}
counts_flp_compiled_all <- counts_flp_compiled %>% 
  # Exclude size fraction:
  group_by(SAMPLE, EXPID, EXP_TYPE, IGT_REP) %>%
  summarise(total_euks_noFLP = sum(total_euks_noFLP),
            total_FLP = sum(total_FLP), 
            total_euks_wflp = sum(total_euks_wflp),
            .groups = "rowwise") %>% 
  add_column(SizeFrac = "total_euks") %>% #Add SizeFrac column
  bind_rows(counts_flp_compiled) %>% # Combine back with flp compiled list
  data.frame
# head(counts_flp_compiled_all)
# filter(counts_flp_compiled_all, SAMPLE == "VD-X18", EXPID == "T40-Rep2")
# filter(counts_flp_compiled_all, SAMPLE == "Piccard-Plume", EXPID == "T10-Rep1")
```

> All three size fractions are represented, total, micro, and nano.

One outstanding question will be that there were many more nano size grazers than micro sized. Here, we will use the total value (micro + nano).

## Calculate FLP per euk cell calculation
Import metadata which has the extact minutes for each time point used. 

```{r Import metadata}
metadata <- read.delim("input-data/flp-exp-metadata-compiled.txt")
exp_metadata <- read.csv("input-data/flp_exp_metadata.csv")
# unique(metadata$REP)
# unique(exp_metadata$REP)
# head(metadata)
```

Add metadata information to FLP data, reformat sample names, and calculate FLP per euk as the total FLP divided by the total number of euk cells counted.
```{r Join meta data modify naming}
counts_flp_calcs_all <- counts_flp_compiled_all %>% 
  # Add in metadata
  # IGTXb are replicate counts, include them as replicates!
  separate(EXPID, c("TimePoint", "REP"), sep = "-", remove = FALSE) %>% mutate(
    REP = ifelse(grepl("IGT5b", REP), "IGT5", REP),
    REP = ifelse(grepl("IGT4b", REP), "IGT4", REP),
    REP = ifelse(grepl("Bag", EXP_TYPE), "Bag", REP)) %>% 
  left_join(metadata, by = c("SAMPLE" = "SAMPLE", "TimePoint" = "TimePoint", "REP" = "REP")) %>% 
  left_join(exp_metadata, by = c("SAMPLE" = "SAMPLE", "REP" = "REP")) %>% 
  separate(SAMPLE, c("Site", "Name"), sep = "-", remove = FALSE) %>%
  separate(EXPID, c("TimePoint", "Replicate_ID"), sep = "-", remove = FALSE) %>%
  ## Treat repeated IGT counts completely separate
  # group_by(SAMPLE, Site, Name, EXPID, TimePoint, Replicate_ID, EXP_TYPE, IGT_REP, SizeFrac) %>%
  ## Treat repeated IGT counts as replicates (e.g., IGT4b and IGT4 == IGT4)
  group_by(SAMPLE, Site, Name, EXPID, TimePoint, Replicate_ID, EXP_TYPE, REP, SizeFrac) %>%
  # FLPperEuk is the total FLP divided by the total number of euk cells counted
  mutate(FLPperEuk = total_FLP/(sum(total_euks_noFLP, total_euks_wflp))) %>%
  unite("Experiment", Name, REP, sep = "-", remove = FALSE) %>%
  data.frame

# filter(counts_flp_calcs_all, SAMPLE == "VD-X18", EXPID == "T40-Rep2")
# filter(counts_flp_calcs_all, SAMPLE == "Piccard-Plume", EXPID == "T10-Rep1")
```

View output
```{r Check output}
head(counts_flp_calcs_all[1:2,])
# unique(counts_flp_calcs_all$Experiment)
# View(counts_flp_calcs_all)
```

> COLS: Timepoint, Minutes = time point label, actual incubated minutes

> COLS: Replicate_ID, REP, and IGT_REP = full replicate identified for IGTs and Bags, designation of biological replicates, and designation of technical replicates for IGT experiments

## Calculate linear regression to obtain slope
Use ```lm()``` function in R to calculate linear regression for each experiment. Slope equates to grazing rate. Function inputs the FLP per euk cell data, performs regression and then adds a column for slope and r-squared values.

```{r Function to calculate lm, warning=FALSE}
calculate_lm <- function(df){
  regression_1 <- df %>%
  type.convert(as.is = TRUE) %>%
  ## Keep technical replicates separate for IGTs
  # group_by(SAMPLE, Site, Experiment, Name, IGT_REP, SizeFrac) %>%
  # nest(-SAMPLE, -Site, -Experiment, -Name, -IGT_REP, -SizeFrac) %>%
  ## Combine technical replicates for IGTs
  group_by(SAMPLE, Site, Experiment, Name, REP, SizeFrac) %>%
  nest(-SAMPLE, -Site, -Experiment, -Name, -REP, -SizeFrac) %>%
  mutate(lm_fit = map(data, ~lm(FLPperEuk ~ Minutes, data = .)),
         tidied = map(lm_fit, tidy)) %>% 
  unnest(tidied) %>% 
  # select(SAMPLE, Site, Experiment, Name, IGT_REP, SizeFrac, term, estimate) %>%
  select(SAMPLE, Site, Experiment, Name, REP, SizeFrac, term, estimate) %>% 
  pivot_wider(names_from = term, values_from = estimate) %>% 
  data.frame
  # Reset column names
  colnames(regression_1) <- c("SAMPLE", "Site", 
                              "Experiment", "Name", "REP",
                              "SizeFrac", "INTERCEPT", "SLOPE")
  # Repeat broom model to get R2
  out_regression <- df %>%
  group_by(SAMPLE, Site, Experiment, Name, REP, SizeFrac) %>%
  nest(-SAMPLE, -Site, -Experiment, -Name, -REP, -SizeFrac) %>%
  mutate(lm_fit = map(data, ~lm(FLPperEuk ~ Minutes, data = .)),
         glanced = map(lm_fit, glance)) %>% 
  unnest(glanced) %>% 
  select(SAMPLE, Site, Experiment, Name, REP, SizeFrac, r.squared) %>% 
  right_join(regression_1) %>% 
  right_join(df) %>% 
  data.frame
  out_regression$SITE <- factor(out_regression$Site, levels = c("VD", "Piccard"))
  out_regression$TYPE <- factor(out_regression$EXP_TYPE, levels = c("Bag", "IGT"))
  return(out_regression)
}
```

> Note that an error may occur when running the below function. This is due to the fact that some experiments did not have replicates.

```{r Apply function to obtain slope, warning=FALSE}
calcs_wslope_regression <- calculate_lm(counts_flp_calcs_all)
# head(calcs_wslope_regression[1:2,])
# View(calcs_wslope_regression)
```

Use below commented out to recalculate one linear regression. Above function uses the ```nest()``` capability of tidyverse. Below, one experiment is subset to check the value.
```{r Linear regression check}
# Extract only plume-bag experiment from VD
# tmp_plume <- filter(counts_flp_calcs_all, Experiment == "Plume-Bag") %>% filter(Site == "VD") %>% filter(SizeFrac == "total_euks")
# tmp_plume # View
# Perform linear regression
# lm_out <- lm(FLPperEuk ~ Minutes, data = tmp_plume)
# # Check output
# summary(lm_out)
# lm_out$coefficients #Intercept=intercept #Minutes = SLOPE
# # Compare with nested function output
# filter(calcs_wslope_regression, Experiment == "Plume-Bag") %>% filter(Site == "VD") %>% filter(SizeFrac == "total_euks") %>% head
```

## Plot linear regression trend
```{r Plot results from bag experiments , tidy=FALSE, fig.height=6, fig.width=7}
calcs_wslope_regression %>% 
  filter(SizeFrac == "total_euks") %>% 
  # filter(TYPE != "IGT") %>% 
  unite(EXPERIMENT, SITE, Experiment, sep = " ", remove = FALSE) %>% 
  ggplot(aes(x = Minutes, y = FLPperEuk, fill = Site, shape = TYPE, group = Experiment)) +
  geom_abline(aes(slope = SLOPE, intercept = INTERCEPT), color = "black", linetype = "dashed", size = 1) +
  geom_point(stat = "identity", color = "black", 
             size = 2, aes(shape = TYPE, fill = Site)) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c("#de2d26", "#1c9099")) +
  labs(x = "Minutes", y = bquote("FLP"~eukaryote^-1), title = "Grazing experiment regression") +
  facet_wrap(. ~ EXPERIMENT) +
  # Report r.squared
  geom_text(aes(x = 42, y = max(FLPperEuk), label = paste(round(SLOPE, 4))), 
            vjust = 1, hjust = 0, size = 3) +
  theme_bw() + 
  theme(strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 7),
                     legend.title = element_blank(),
                     legend.position = "right")
```
Data points represent the FLP per euk cells (based on total eukaryote cells counts). Y-axis represents the duration of incubation (in minutes). The dashed purple line reprents the slope and intercept of the experiment. 

## Remove Tf-IGT experiments
IGT experiment results appear to have bottle effect, especially in the final time point. Additionally, due to the lack of biological replicates in the IGT experiments, technical replicates are treated as biological replicates in the regression below.

```{r Remove IGT Tf and recalculate}
IGT_lm_woTf <- counts_flp_calcs_all %>% 
  # Select only IGT experiments with total eukaryotes, remove Tf (T3)
  filter(SizeFrac == "total_euks") %>% 
  filter(EXP_TYPE == "IGT" & !(TimePoint == "T3")) %>% 
  add_column(IGT_cor = "rm Tf") %>% 
  data.frame

# Recalculate lm(), keep replicates separate
igt_regression_noTf <- calculate_lm(IGT_lm_woTf) # Recalculate
```

Plot IGT grazing experiment with newly calculated grazing effect.
```{r plot igt only, tidy=FALSE, fig.height=4, fig.width=5}
igt_regression_noTf %>% 
  # filter(SizeFrac == "total_euks") %>% 
  # filter(TYPE != "IGT") %>% 
  unite(EXPERIMENT, SITE, Experiment, sep = " ", remove = FALSE) %>% 
  ggplot(aes(x = Minutes, y = FLPperEuk, fill = Site, shape = TYPE, group = Experiment)) +
  geom_abline(aes(slope = SLOPE, intercept = INTERCEPT), color = "black", linetype = "dashed", size = 1) +
  geom_point(stat = "identity", color = "black", 
             size = 2, aes(shape = TYPE, fill = Site)) +
  scale_shape_manual(values = c(24)) +
  scale_fill_manual(values = c("#de2d26", "#1c9099")) +
  labs(x = "Minutes", y = bquote("FLP"~eukaryote^-1), title = "Grazing experiment regression") +
  facet_wrap(. ~ EXPERIMENT) +
  # Report r.squared
  geom_text(aes(x = 5, y = max(FLPperEuk), label = paste(round(SLOPE, 4))), 
            vjust = 1, hjust = 0, size = 3) +
  theme_bw() + 
  theme(strip.background = element_blank(),
        strip.text = element_text(color = "black", size = 7),
                     legend.title = element_blank(),
                     legend.position = "right")
```
IGT grazing regression without the Tf data point appear more consistent. Keeping that one.

## Compile grazing experiment results
```{r Compile with modified IGT results}
calcs_wslope_regression_update <- calcs_wslope_regression %>% 
  filter(TYPE != "IGT") %>% 
  bind_rows(igt_regression_noTf %>% select(-IGT_cor)) %>% 
  data.frame

# Factor
vent_ids <- c("BSW","Plume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole")
vent_fullname <- c("Background","Plume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole")
site_ids <- c("VD", "Piccard")
site_fullname <- c("Von Damm", "Piccard")
# Factor for shipboard
calcs_wslope_regression_update$SiteOrder <- factor(calcs_wslope_regression_update$Site, levels = site_ids, labels = site_fullname)
calcs_wslope_regression_update$NameOrder <- factor(calcs_wslope_regression_update$Name, levels = vent_ids, labels = vent_fullname)

# dim(calcs_wslope_regression); dim(calcs_wslope_regression_update)
# head(calcs_wslope_regression_update)
```

## Check FLP control experiments
All incubations had control experiments run alongside them. This was to ensure added FLP did not decrease or change in concentration over time.
```{r Import and set up}
bac_ctrl <- read.delim("input-data/bac-counts-compiled.txt")
# dim(bac_ctrl)
dtaf <- bac_ctrl %>% 
  separate(SampleID, c("exp", "Replicate", "TimePoint"), sep = "-", remove = FALSE) %>% 
  separate(Site, c("Site", "Name"), sep = "-", remove = FALSE) %>% 
  filter(Stain == "DTAF") %>% 
  data.frame
# View(bac_ctrl)
# head(dtaf)

dtaf_avg <- dtaf %>% 
  group_by(TimePoint, Stain, Site, Name) %>% 
  summarise(Avg_cellsperml = mean(Cells.ml)) %>% 
  data.frame
```

```{r Plot average FLP in controls, tidy=FALSE, fig.height=6, fig.width=7}
dtaf_avg %>% 
  filter(Site != "IGT") %>% 
  ggplot(aes(x = TimePoint, y = Avg_cellsperml, fill = Name, shape = Site)) +
  geom_rect(data = filter(dtaf_avg, TimePoint == "T0", Site != "IGT"), aes(
                                           ymin = (Avg_cellsperml-(0.1*Avg_cellsperml)),
                                           ymax = (Avg_cellsperml+(0.1*Avg_cellsperml))), color = NA, alpha = 0.4, xmin = 0, xmax = 6, fill = "black") +
  geom_line(aes(group = Name)) +
  geom_point(stat = "identity", aes(shape = Site, fill = Name), size = 2) +
  # scale_fill_manual(values = c("black","#9970ab", "#5aae61")) +
  facet_wrap(Name ~ Site) +
  scale_y_log10() +
  theme_bw() + theme(strip.background = element_blank(), 
                          legend.title = element_blank(),
                     axis.text = element_text(size = 10, color = "black"),
                          title = element_text(size = 10, face = "bold"),
                          axis.title = element_text(size = 9)) +
  labs(title = "FLP counts for controls", y = bquote("Log FLP "~mL^-1), x = "Time point")
```
Control experiments look ok for now.

```{r Plot for IGT, tidy=FALSE, fig.height=3, fig.width=4}
dtaf_avg %>% 
  filter(Site == "IGT") %>% 
  ggplot(aes(x = TimePoint, y = Avg_cellsperml, fill = Name, shape = Site)) +
  geom_rect(data = filter(dtaf_avg, TimePoint == "T0", Site == "IGT"), aes(
                                           ymin = (Avg_cellsperml-(0.1*Avg_cellsperml)),
                                           ymax = (Avg_cellsperml+(0.1*Avg_cellsperml))), color = NA, alpha = 0.4, xmin = 0, xmax = 6, fill = "black") +
  geom_line(aes(group = Name)) +
  geom_point(stat = "identity", aes(shape = Site, fill = Name), size = 2) +
  # scale_fill_manual(values = c("black","#9970ab", "#5aae61")) +
  facet_wrap(Name ~ Site) +
  scale_y_log10() +
  theme_bw() + theme(strip.background = element_blank(), 
                          legend.title = element_blank(),
                     axis.text = element_text(size = 10, color = "black"),
                          title = element_text(size = 10, face = "bold"),
                          axis.title = element_text(size = 9)) +
  labs(title = "FLP counts for controls", y = bquote("Log FLP "~mL^-1), x = "Time point")
```

## Table with grazing values
```{r Compile table with rates}
# head(calcs_wslope_regression_update)
# View(calcs_wslope_regression_update)
# Generate final table
bsw <- c("Plume", "Background")

table_grazerate <- calcs_wslope_regression_update %>% 
  filter(SizeFrac == "total_euks") %>% 
  select(SAMPLE, FLUID_ORIGIN, CRUISE_SAMPLE, SiteOrder, NameOrder, SLOPE, EXP_TYPE, EXP_REPS, EXP_VOL, CTRL_REPS, CTRL_VOL, Site=SiteOrder, Name=NameOrder, RATE = SLOPE, Minutes) %>% 
  distinct() %>% 
  group_by(SAMPLE, FLUID_ORIGIN, CRUISE_SAMPLE, EXP_TYPE, EXP_REPS, EXP_VOL, CTRL_REPS, CTRL_VOL, Site, Name, RATE) %>% 
  summarise(TimePoints = str_c(Minutes, collapse = ", ")) %>% 
  ungroup() %>%
  mutate(GRAZE_RATE = case_when(
    RATE < 0 ~ 0,
    TRUE ~ RATE
  ),
  type = case_when(
    Name == "Plume" ~ "Plume",
    Name == "Background" ~ "Background",
    EXP_TYPE == "IGT" ~ "Vent-IGT",
    EXP_TYPE == "Bag" ~ "Vent-Bag"
  )) %>%
  data.frame
# View(table_grazerate)
```


Add FLP conc to table
```{r Add FLP conc to table}
# head(table_grazerate)
dtaf_igt <- 5352.8278 # Manually insert FLP concentration for IGT experiments; this value is estimated from how IGT FLP spike-ins were calculated
# 
table_grazerate_wflp <- bac_ctrl %>%
  filter(FLP_t0 == "use") %>%
  add_column(EXP_TYPE = "Bag") %>%
  group_by(Site, EXP_TYPE) %>%
  summarise(FLP_conc = mean(Cells.ml)) %>%
  right_join(table_grazerate, by = c("Site" = "SAMPLE", "EXP_TYPE" = "EXP_TYPE")) %>%
  mutate(FLP_conc = ifelse(EXP_TYPE == "IGT", dtaf_igt, FLP_conc)) %>%
  select(everything(), FIELD = `Site.y`) %>% 
  data.frame
# View(table_grazerate_wflp)
```


```{r Factor to plot grazing rate both sites}
# Factoring
type_order <- c("Vent-Bag", "Vent-IGT", "Plume", "Background")
table_grazerate_wflp$TYPE <- factor(table_grazerate_wflp$type, levels = type_order)
vent_ids <- c("BSW","Plume", "Shrimpocalypse", "LotsOShrimp", "X18", "OMT", "Rav2", "MustardStand", "ShrimpHole")
vent_fullname <- c("Background","Plume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole")
site_ids <- c("VD", "Piccard")
site_fullname <- c("Von Damm", "Piccard")
vent_colors <- c("#0868ac", "#41ab5d", "#e7298a", "#c994c7", "#fc4e2a", "#fed976", "#6a51a3", "#ffeda0", "#a1d99b")
names(vent_colors) <- vent_fullname
table_grazerate_wflp$NAME <- factor(table_grazerate_wflp$Name, levels = vent_fullname)
head(table_grazerate_wflp)
```


```{r Plot grazing rate by site, tidy=FALSE, fig.height=4, fig.width=6}
# svg("", h =, w = )
grazing_min_plot <- table_grazerate_wflp %>% 
  ggplot(aes(y = GRAZE_RATE, x = NAME, shape = EXP_TYPE, fill = FIELD)) +
  geom_jitter(stat = "identity", aes(shape = EXP_TYPE, fill = FIELD),
              color = "black", size = 3, width = 0.3) +
  scale_shape_manual(values = c(21, 24)) +
  scale_fill_manual(values = c("#de2d26", "#1c9099")) +
  facet_grid(.~Site, space = "free", scales = "free") +
  # coord_flip() +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
           panel.background = element_blank(), 
           axis.line = element_line(colour = "black"), 
           axis.text.x = element_text(color="black", size = 12, 
                                      angle = 45, hjust = 1, vjust = 1), 
           axis.text.y = element_text(color="black", size = 12),
           axis.title =element_text(color="black", size = 12),
           axis.ticks = element_line(),
           strip.text =element_blank(), legend.title = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
       shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = bquote("FLP " ~grazer^-1 ~min^-1))
# dev.off()
grazing_min_plot
```



# Plot cell conc & grazing
Generate final plots that show eukaryote and prokaryote biomass and cell concentration. Save final table reporting carbon estimates.

```{r extract average cell conc}
# Subset the average in situ prok cells/ml for non-background samples
tmp <- filter(insitu_proks, Name != "BSW", Name != "Plume") %>% select(MEAN)
avg_insitu <- mean(tmp$MEAN)
# head(insitu_proks)

# Add to master table with data
table_grazerate_wflp_wprok <- insitu_proks %>% 
  select(Site = SAMPLE, Prok_conc = MEAN, Prok_sem = SEM) %>% 
  right_join(table_grazerate_wflp) %>% 
  mutate(Prok_conc = ifelse(is.na(Prok_conc), avg_insitu, Prok_conc)) %>% 
  data.frame
```

Table with all cell count data
```{r Compile table with all cell count}
# head(table_grazerate_wflp_wprok)
# head(plot_euk_format) # from above
# names(plot_euk_format)
# names(table_grazerate_wflp_wprok)
table_grazerate_wflp_wprok_weuk <- plot_euk_format %>% 
  select(Name = NameOrder, FIELD = SiteOrder, euk_conc = avg_conc, EXP_TYPE, euk_conc_sem = SEM_conc) %>%
  right_join(table_grazerate_wflp_wprok) %>% 
  select(FIELD, NAME = Name, EXP = EXP_TYPE, SAMPLE = Site, RATE_min = GRAZE_RATE, FLP_ml = FLP_conc, PROK_ml = Prok_conc, PROK_sem = Prok_sem, EUK_ml = euk_conc, EUK_sem = euk_conc_sem, TimePoints, EXP_REPS, EXP_VOL,  CTRL_REPS, CTRL_VOL) %>%
  data.frame
```

# Grazing rate calculations
```{r Report full table}
# head(table_grazerate_wflp_wprok_weuk)
```

Based on Unrein et al. 2007, we use the estimated grazing rate, in situ prok abundance, in situ euk abundance, and the concentration of FLP to make additional estimates. 

```{r Rate calculations}
table_wcalcs <- table_grazerate_wflp_wprok_weuk %>%
  # Ingestion rate per hour
  mutate(RATE_hr = (RATE_min * 60),
         RATE_day = (RATE_hr * 24), #Compare to GR?
         # FLP concentration per L
         FLP_L = (FLP_ml * 1000),
         # mL per grazer per hr
         CLEARANCE_RATE_ml = (RATE_hr/FLP_ml),
         # nL per grazer per hour
         CLEARANCE_RATE_nL = ((RATE_hr/FLP_ml)/1.00E+6), 
         # proks per grazer per hr
         SPEC_GRAZE_RATE_hr = (CLEARANCE_RATE_ml * PROK_ml), 
         # proks per grazer per day
         GRAZE_RATE_DAY = (24 * SPEC_GRAZE_RATE_hr),
         # proks per ml per hr
         GRAZING_EFFECT_hr = (SPEC_GRAZE_RATE_hr * EUK_ml),
         GRAZING_EFFECT_hr_min = (SPEC_GRAZE_RATE_hr * (EUK_ml - EUK_sem)),
         GRAZING_EFFECT_hr_max = (SPEC_GRAZE_RATE_hr * (EUK_ml + EUK_sem)),
         # cells per ml per day
         GRAZING_EFFECT_day = ((SPEC_GRAZE_RATE_hr * 24) * EUK_ml),
         # Percentage per day
         BAC_TURNOVER_PERC = 100*(GRAZING_EFFECT_day / PROK_ml),
         BAC_TURNOVER_PERC_min = 100*(GRAZING_EFFECT_day / (PROK_ml - PROK_sem)),
         BAC_TURNOVER_PERC_max = 100*(GRAZING_EFFECT_day / (PROK_ml + PROK_sem))) %>% 
  data.frame
# View(table_wcalcs)
```

Explanation of units for table with calculated values.

* RATE_min & RATE_hr = Grazing rate as 'FLPs per grazer per minute' and per hour

* CLEARANCE_RATE = ml or nL per grazer per hour

* SPEC_GRAZE_RATE (Specific grazing rate) = Prokaryotes per grazer per hour

* GRAZING EFFECT = bacteria per ml per hour

* Bacterial turnover rate = % per day

# Carbon biomass table construction

_Unrein, F., Massana, R., Alonso-Sáez, L., and Gasol, J.M. (2007) Significant year-round effect of small mixotrophic flagellates on bacterioplankton in an oligotrophic coastal system. Limnol Oceanogr 52: 456–469._


```{r, fig.height=10, fig.width=18}
colnames(table_wcalcs)
bkgd <- c("Background", "Plume")

library(gt)

table_wcalcs %>% 
  mutate(loc_type = case_when(
    NAME %in% bkgd ~ "Background",
    TRUE ~ "Vent fluid"
  )) %>%
  # group_by(loc_type, SITE, EXP) %>% 
  select(-SAMPLE) %>% 
  gt(
    groupname_col = c("FIELD", "EXP", "loc_type"),
    rowname_col = "NAME"
  ) %>% 
  cols_label(RATE_min = html("minute<sup>-1</sup>"),
             RATE_hr = html("hour<sup>-1</sup>"),
             RATE_day = html("day<sup>-1</sup>"),
             EXP_REPS = html("# of incubations"),
             FLP_ml = html("FLP ml<sup>-1</sup>"),
             PROK_ml = html("Prokaryote cells ml<sup>-1</sup>"),
             PROK_sem = html("SEM prokaryote cells ml<sup>-1</sup>"),
             EUK_ml = html("Eukaryote cells ml<sup>-1</sup>"),
             EUK_sem = html("SEM eukaryote cells ml<sup>-1</sup>"),
             FLP_L = html("FLP L<sup>-1</sup>"),
             CLEARANCE_RATE_ml = html("ml grazer<sup>-1</sup> hr<sup>-1</sup>"),
             CLEARANCE_RATE_nL = html("nl grazer<sup>-1</sup> hr<sup>-1</sup>"),
             SPEC_GRAZE_RATE_hr = html("Prokaryote grazer<sup>-1</sup> hr<sup>-1</sup>"),
             GRAZE_RATE_DAY = html("Prokaryote grazer<sup>-1</sup> day<sup>-1</sup>"),
             GRAZING_EFFECT_hr = html("Prokaryote ml<sup>-1</sup> hr<sup>-1</sup>"),
             GRAZING_EFFECT_hr_min = html("MIN"),
             GRAZING_EFFECT_hr_max = html("MAX"),
             GRAZING_EFFECT_day = html("Prokaryote ml<sup>-1</sup> day<sup>-1</sup>"),
             BAC_TURNOVER_PERC = html("Bacteria turnover % day<sup>-1</sup>"),
             BAC_TURNOVER_PERC_min = html("MIN"),
             BAC_TURNOVER_PERC_max = html("MAX")) %>% 
  tab_spanner(
    label = (html("Turnover")),
    columns = starts_with("BAC_TURNOVER")
  ) %>% 
  tab_spanner(
    label = (html("Grazing rate: prokaryote cells consumed")),
    columns = starts_with("GRAZING_EFFECT")
  ) %>% 
  tab_spanner(
    label = (html("ml grazer<sup>-1</sup> hr<sup>-1</sup>")),
    columns = c(CLEARANCE_RATE_ml, CLEARANCE_RATE_nL)
  ) %>% 
  tab_spanner(
    label = html("Specific grazing rate"),
    columns = c(SPEC_GRAZE_RATE_hr, GRAZE_RATE_DAY)
  ) %>% 
  tab_spanner(
    label = (html("FLPs grazer<sup>-1</sup>")),
    columns = c(RATE_hr, RATE_min, RATE_day),
  ) %>% 
  tab_spanner(
    label = (html("Cell counts")),
    columns = c(PROK_ml, PROK_sem, EUK_ml, EUK_sem, FLP_L, FLP_ml),
  ) %>% 
  tab_source_note(source_note = "NAs indicate values were unavailable.
                  Zero values for rates indicate no grazing pressure detected.") %>% 
  fmt_scientific(columns = everything()) %>% 
  tab_options(
    table.font.size = 12,
    table.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.width= px(3),
    table.width = pct(100))
```

# Estimates of carbon biomass and consumption

## Protist carbon-measured
References for estimating biovolume _Pernice, M.C., Forn, I., Gomes, A., Lara, E., Alonso-Sáez, L., Arrieta, J.M., et al. (2015) Global abundance of planktonic heterotrophic protists in the deep ocean. ISME J 9: 782–792._

```{r Import and process biovolumes, tidy=FALSE}
# Import manual biovolume measurements
biov <- read.delim("input-data/biovol-euk-12-10-2020.txt")
# head(biov)

# Calculate volume
biov_calc <- biov %>% 
  mutate(SizeFrac = case_when(
    h >= 20 ~ "micro",
    TRUE ~ "nano")) %>% 
  mutate(Volume = ((pi/6) * (d^2) * d)) %>% # Calculate volume (um cubed) # Hillebrand et al. 1999
  mutate(pgC_cell = (0.216 * (Volume^0.939))) %>% # Calculate Cell biomass in pg C per cell # Menden-Deuer and Lessard 2000
  data.frame
# View(biov_calc)
biov_calc
```

> Volume is reported as um^3

```{r Summary of biovolumes}
# Volume by experiment type
biov_calc %>% 
  group_by(EXP) %>% summarise(VOL = mean(Volume), C = mean(pgC_cell))
# Volume by euk size
biov_calc %>% 
  group_by(SizeFrac) %>% summarise(VOL = mean(Volume), C = mean(pgC_cell))
# Volume by site
biov_calc %>% 
  group_by(VENT_BSW) %>% summarise(VOL = mean(Volume), C = mean(pgC_cell))
# head(biov_calc)
euk_vol <- mean(biov_calc$Volume);euk_vol # in um^3
euk_carbon <- mean(biov_calc$pgC_cell); euk_carbon # in pg C per cell
euk_carbon_min <- min(biov_calc$pgC_cell); euk_carbon_min
euk_carbon_max <- max(biov_calc$pgC_cell); euk_carbon_max
# euk_carbon
```

Avg euk biomass pg C per individual cell == ```{r}euk_carbon```


## Protist carbon-literature

Compare with Menden-Deuer and Lessard 2000, Table 2 - using only the heterotrophic species measured. Based on Table 2, the min volume was 4745 and the maximum was 1.2 x10^7 µm^3. Carbon content was measured at pg per cell, this was 469.48-35,339 pg per cell. 

Import the heterotroph species volume and carbon content to compare to my measured values.
```{r Compare carbon ranges, tidy=FALSE, fig.height=7, fig.width=10}
# Hu-measured
range(biov_calc$Volume)
range(biov_calc$pgC_cell)

c_prev <- read.delim("input-data/md-lessard-2000.txt") # Table 2, heterotrophs only

# combine and plot
carbon_compare <- c_prev %>% 
  add_column(source = "Menden-Deuer Lessard") %>% 
  select(source, Volume = vol, pgC_cell) %>% 
  rbind(biov_calc %>% add_column(source = "MCR") %>% select(source, Volume, pgC_cell)) %>% 
    ggplot(aes(x = Volume, y = pgC_cell, fill = source)) +
      geom_point(aes(fill = source), shape = 23, color = "black", size = 3) +
      scale_y_log10() + scale_x_log10() +
      labs(title = "Compare literature to measured cell volume & C content",
           x = bquote("Volume" ~µm^-3),
           y = bquote("pg C" ~cell^-1)) +
      theme_bw() + theme(legend.title = element_blank(),
                         axis.title = element_text(size = 14),
                         axis.text = element_text(size = 14),
                         legend.text = element_text(size = 14))

carbon_compare
```
Upon comparison, the measured carbon content was much lower from the grazing experiments. This makes sense, as I am looking at preserved specimen and a smaller total number of cells. AND the deep-sea protist cell sizes may be smaller overall. 

Find lowest estimates or protist carbon, benthic estimates, and others?
How does it compare to my measurements?

```{r Grab carbon literature values}
euk_carbon_lit_mean <- mean(c_prev$pgC_cell)
euk_carbon_lit_min <- min(c_prev$pgC_cell)
euk_carbon_lit_max <- max(c_prev$pgC_cell)
```


## Prokaryote carbon-literature
Below adding in biomass estimates from prokaryotes and protists.
```{r Incorporate prokaryote carbon estimates}
bac_carbon_ug <- (86)*(1.00E-9) # From Derived from Morono et al. 2011 
# bac_carbon_ug
bac_carbon_ug_2 <- (173)*(1.00E-9) # Derived from McNichol et al. 2018; LOFERER-KRO ̈ ßBACHER, J. KLIMA & R. PSENNER 1998
# table_wcalcs
```

## Generate carbon biomass table

Incorporate calculations that include biomass of population and ug C consumed. For rate measurements, only incorporate the Morono et al. 2011 biomass for prokaryotes. This way it is on the lower end and is comparable to Gorda Ridge work.

NEED TO MODIFY SO IT INCLUDES BIOMASS OF EUK AND PROK AT EACH SITE

```{r Add biomass data to table}
bsw <- c("Plume", "Background")

table_wcalcs_biomass <- table_wcalcs %>% 
  add_column(euk_C_ug_Hu = (euk_carbon / (1.00E+06))) %>% # Convert to ug from pg
  add_column(euk_C_ug_lit = (euk_carbon_lit_mean / (1.00E+06))) %>% # literature
  add_column(bac_C_ug = bac_carbon_ug) %>% 
  add_column(bac_C_ug_2 = bac_carbon_ug_2) %>%
  # Grazing rate in ug C per bac per day
  mutate(RATE_ugCbac_pergrazer_perday = (RATE_hr * 24 * bac_C_ug), # Grazing rate as ug C per grazer per day
         # % of cell carbon per day
         SPEC_INGESTION_RATE = (RATE_ugCbac_pergrazer_perday / euk_C_ug_Hu),
         SPEC_INGESTION_RATE_lit = (RATE_ugCbac_pergrazer_perday / euk_C_ug_lit),
         Prok_biomass = PROK_ml * bac_carbon_ug,
         Euk_biomass_Hu = EUK_ml * euk_C_ug_Hu,
         Euk_biomass_lit = EUK_ml * euk_C_ug_lit,
         Prok_biomass_L = PROK_ml * bac_carbon_ug * 1000,
         Euk_biomass_Hu_L = EUK_ml * euk_C_ug_Hu * 1000,
         Euk_biomass_lit_L = EUK_ml * euk_C_ug_lit * 1000,
         # Repeat with SEM values
         Prok_biomass_sem = PROK_sem * bac_carbon_ug,
         Euk_biomass_Hu_sem = EUK_sem * euk_C_ug_Hu,
         Euk_biomass_lit_sem = EUK_sem * euk_C_ug_lit,
         Prok_biomass_sem_L = PROK_sem * (bac_carbon_ug* 1000),
         Euk_biomass_Hu_sem_L = EUK_sem * (euk_C_ug_Hu * 1000),
         Euk_biomass_lit_sem_L = EUK_sem * (euk_C_ug_lit * 1000)) %>% 
  type.convert(as.is = TRUE) %>%
  mutate(detected = case_when(
    RATE_min < 0 ~ "Not detected",
    TRUE ~ "Detected")) %>% 
  mutate(type = case_when(
    NAME %in% bsw ~ NAME,
    TRUE ~ paste("Vent", EXP, sep="-")
  )) %>% 
  mutate(GRAZE_RATE = case_when(
    RATE_min < 0 ~ 0,
    TRUE ~ RATE_min
  )) %>% 
  mutate(type_site = case_when(
    NAME %in% bsw ~ NAME,
    TRUE ~ "Vent"
  )) %>%
  data.frame
# View(table_wcalcs_biomass)
```

* Grazing rate column == FLP per minute consumed
* Grazing effect hr == cells per ml per hr

Also make a "bounded" table that demonstrates the ug C consumed in the context of McNichol et al.
```{r bounded table}
# G = number of cells grazed during experiment duration
table_wcalcs_biomass_bounded <- table_wcalcs_biomass %>% 
  add_column(fgC_cell = 86) %>% # Add in Morono et al. 2011 value
  mutate(
    # cells_consumed_perday = (G / 1), # Rate of cells consumed * in situ prok, per day
    fgC_ml_perday = (GRAZING_EFFECT_day * fgC_cell), # Convert cell amount to fg C
    ugC_L_perday = (fgC_ml_perday * (1e-09) * 1000), # Convert to ug C per L
    lower_mcnichol = 100*(ugC_L_perday / 17.3),
    upper_mcnichol = 100*(ugC_L_perday / 321.4)
  ) %>% 
  data.frame
```


```{r Save carbon table}
head(table_wcalcs_biomass_bounded)
# View(table_wcalcs_biomass_bounded)
write_delim(table_wcalcs_biomass_bounded, file = "table-wcalc.txt", delim = "\t")
# ?write_delim()
```

# Plot environmental parameters
```{r}
env_metadata <- read.csv(file = "input-data/samplelist-metadata.csv")
head(env_metadata)
# FIELD, NAME

mcr_metadata_wenv <- env_metadata %>%
  filter(SITE == "VonDamm" | SITE  == "Piccard") %>% 
  mutate(FIELD =  case_when(
    SITE == "VonDamm"  ~ "Von Damm",
    SITE == "Piccard" ~ "Piccard")) %>% 
  filter(SAMPLETYPE != "Incubation") %>% 
  select(-Sample_or_Control, -SAMPLEID, -ref_num, -SITE, SEQ_SAMPLE = SAMPLE, everything()) %>% 
  left_join(table_wcalcs_biomass_bounded %>% 
               separate(SAMPLE, into = c("site", "VENT0"), sep = "-") %>%
               mutate(VENT = case_when(
                 VENT0 == "OMT" ~ "OldManTree",
                 TRUE ~ VENT0))) %>% 
  select(-site, -VENT0)
# ?right_join
# View(mcr_metadata_wenv)
```

```{r}
write_delim(mcr_metadata_wenv, file = "table_wenv.txt")
```

```{r}
str(mcr_metadata_wenv)
unique(mcr_metadata_wenv$detected)

tmp<- mcr_metadata_wenv %>% 
  mutate(Grazing = case_when(
    detected == "Detected" ~ 1,
    TRUE ~ 0
  ),
  Sequencing = case_when(
    !is.na(SEQ_SAMPLE) ~ 1,
    TRUE ~ 0
  ),
  NAME = case_when(
    is.na(NAME) ~ VENT,
    TRUE ~ NAME
  )) %>% 
  select(-Sample_actual, -detected, -SEQ_SAMPLE, -YEAR, -Type, -ref_num, -SITE, -Sample_or_Control, -SAMPLEID, -NAME, -EXP) #%>%
  # group_by(FIELD, VENT, SAMPLETYPE, COORDINATES) %>% 
  # select(FIELD, VENT, SAMPLETYPE, COORDINATES, Grazing, Sequencing, everything()) %>%
  
  # distinct() %>%
  # pivot_longer(names_to = "VARIABLE", values_to = "VALUE")
# ?pivot_longer
View(tmp)
```


## Compilation of plots

Format and factor values to plot.
* Grazing rate column == FLP per minute consumed
* Grazing effect hr == cells per ml per hr
* Specific ingestion rate == % of cell carbon per day, estimated with literature and measured carbon values
```{r Format and factor for plots, tidy=FALSE}
biomass_rate_plot <- table_wcalcs_biomass_bounded %>% 
  select(SITE, NAME, EXP, SAMPLE, type, 
        PROK_ml, EUK_ml, PROK_sem, EUK_sem,
        Prok_biomass_L, Euk_biomass_Hu_L, Euk_biomass_lit_L,
        Prok_biomass_sem_L, Euk_biomass_Hu_sem_L, Euk_biomass_lit_sem_L,
        GRAZING_EFFECT_hr, GRAZING_EFFECT_hr_min, GRAZING_EFFECT_hr_max, BAC_TURNOVER_PERC, BAC_TURNOVER_PERC_min, BAC_TURNOVER_PERC_max,
        GRAZE_RATE, RATE_ugCbac_pergrazer_perday,
        SPEC_INGESTION_RATE, SPEC_INGESTION_RATE_lit) %>% 
  pivot_longer(cols = c(PROK_ml, EUK_ml,
                        Prok_biomass_L, Euk_biomass_Hu_L, Euk_biomass_lit_L,
                        GRAZING_EFFECT_hr, BAC_TURNOVER_PERC,
                        GRAZE_RATE, RATE_ugCbac_pergrazer_perday,
                        SPEC_INGESTION_RATE, SPEC_INGESTION_RATE_lit),
               names_to = "Variable", values_to = "Value") %>% 
  pivot_longer(cols = c(PROK_sem, EUK_sem, Prok_biomass_sem_L, Euk_biomass_Hu_sem_L, Euk_biomass_lit_sem_L,
                        BAC_TURNOVER_PERC_max, BAC_TURNOVER_PERC_min, GRAZING_EFFECT_hr_max, GRAZING_EFFECT_hr_min, GRAZING_EFFECT_hr_max),
               names_to = "SEM_variable", values_to = "SEM") %>% 
  data.frame

biomass_rate_plot$NAME_ORDER <- factor(biomass_rate_plot$NAME, levels = c("Background","Plume", "Quakeplume", "Shrimpocalypse", "Lots 'O Shrimp", "X-18", "Old Man Tree", "Ravelin #2", "Mustard Stand", "Shrimp Hole", "Hot Chimlet #1", "Shrimp Gulley", "South of Hot Chimlet", "South of LungSnack", "Arrow Loop", "Bartizan", "Ravelin #1"))

biomass_rate_plot$VARIABLE_ORDER <- factor(biomass_rate_plot$Variable, 
                                           levels = c("PROK_ml", "EUK_ml",
                                                      "Prok_biomass_L", "Euk_biomass_Hu_L", "Euk_biomass_lit_L",
                                                      "GRAZING_EFFECT_hr", "BAC_TURNOVER_PERC",
                                                      "GRAZE_RATE", "RATE_ugCbac_pergrazer_perday",
                                                      "SPEC_INGESTION_RATE", "SPEC_INGESTION_RATE_lit"),
                                           labels = c("Prokaryote~cells~mL^{-1}", "Eukaryote~cells~mL^{-1}",
                                                      "Prokaryote~µg~C~L^{-1}", "Measured~eukaryote~µg~C~L^{-1}", "Literature-based~eukaryote~µg~C~L^{-1}",
                                                      "Cells~mL^{-1}~hr^{-1}", "Prokaryote~turnover~'%'~d^{-1}",
                                                      "FLP~consumed~min^{-1}", "µg~C~grazer^{-1}~day^{-1}",
                                                      "Cell~carbon~%~day^{-1}", "Cell~carbon~%~day^{-1}~(lit)"))

# View(biomass_rate_plot)
```

Function to generate consistent plots for Mid-Cayman Rise cell concentration and biomass data.
```{r Plot for mid-cayman rise results, tidy=FALSE, fig.height=4, fig.width=9}
conc_rate_plot_mcr <- function(df, var, sem){
  df %>% 
    filter(Variable == var) %>%
    filter(SEM_variable == sem) %>% 
    ggplot(aes(y = Value, x = NAME_ORDER, shape = EXP, fill = SITE)) +
    geom_errorbar(aes(ymax = (Value + SEM), ymin = (Value - SEM)), 
                  width = 0.2, position = position_dodge(width = 0.4)) +
    geom_point(stat = "identity", aes(shape = EXP, fill = SITE),
               color = "black", size = 3, position = position_dodge(width = 0.4)) +
    scale_shape_manual(values = c(21, 23)) +
    scale_fill_manual(values = c("#de2d26", "#1c9099")) +
    facet_wrap(VARIABLE_ORDER ~ ., scales = "free", 
               strip.position = c("left"), labeller = label_parsed) +
    scale_y_log10() +
    # scale_y_log10(labels = function(x) format(x, scientific = TRUE)) +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 14),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = "")
}
```

```{r, tidy=FALSE, fig.height=12, fig.width=7}
# svg("cells-per-ml-yaxies.svg", h = 8, w = 13)
plot_grid(conc_rate_plot_mcr(biomass_rate_plot, "PROK_ml", "PROK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "EUK_ml", "EUK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "Prok_biomass_L", "Prok_biomass_sem_L"),
          conc_rate_plot_mcr(biomass_rate_plot, "Euk_biomass_Hu_L", "Euk_biomass_Hu_sem_L"))
# dev.off()
# svg("MCR-only-cellcounts-grazingrate.svg", h=12, w=7)
plot_grid(conc_rate_plot_mcr(biomass_rate_plot, "PROK_ml", "PROK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "EUK_ml", "EUK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "GRAZING_EFFECT_hr", "Prok_biomass_sem_L"), ncol = 1)
# dev.off()
```
Repeat plot
```{r}
plot_grid(conc_rate_plot_mcr(biomass_rate_plot, "PROK_ml", "PROK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "EUK_ml", "EUK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "GRAZING_EFFECT_hr", "Prok_biomass_sem_L"), ncol = 1)
```


```{r See subset of grazing pressure results, tidy=FALSE}
subset <- c("GRAZING_EFFECT_hr", "RATE_ugCbac_pergrazer_perday")
biomass_rate_plot %>%
  filter(Variable %in% subset) %>% 
  group_by(EXP, type, Variable) %>% 
  summarise(MEAN = mean(Value))
# 8.577791e+03	- 1.214981e+03	
```


```{r Plot grazing rates within MCR, tidy=FALSE, fig.height=7, fig.width=6}
# scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
grazing_rate <- biomass_rate_plot %>% 
  type.convert(as.is = TRUE) %>%
    filter(Variable == "GRAZING_EFFECT_hr") %>%
    filter(SEM_variable == "GRAZING_EFFECT_hr_min" | SEM_variable == "GRAZING_EFFECT_hr_max") %>% 
    pivot_wider(names_from = SEM_variable, values_from = SEM) %>% 
    ggplot(aes(y = Value, x = NAME_ORDER, shape = EXP, fill = SITE)) +
    geom_errorbar(aes(ymax = (GRAZING_EFFECT_hr_max), ymin = (GRAZING_EFFECT_hr_min)), 
                  width = 0.2, position = position_dodge(width = 0.4)) +
    geom_point(stat = "identity", aes(shape = EXP, fill = SITE),
               color = "black", size = 3, position = position_dodge(width = 0.4)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_manual(values = c("#de2d26", "#1c9099")) +
    facet_wrap(VARIABLE_ORDER ~ ., scales = "free", 
               strip.position = c("left"), labeller = label_parsed) +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = "")
# class(grazing_rate)
# head(biomass_rate_plot)
# svg("plot-grazing-withscale.svg", h = 7, w = 6)
# grazing_rate
plot_grid(grazing_rate + scale_y_continuous(limits = c(0,2000)),
          grazing_rate,
          ncol = 1, rel_heights = c(0.6,1))
# dev.off()
```


```{r Plot grazing rate, tidy=FALSE, fig.height=5, fig.width=6}
# scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
prok_turnover <- biomass_rate_plot %>% 
    filter(Variable == "BAC_TURNOVER_PERC") %>%
    filter(SEM_variable == "BAC_TURNOVER_PERC_min" | SEM_variable == "BAC_TURNOVER_PERC_max") %>% 
    pivot_wider(names_from = SEM_variable, values_from = SEM) %>% 
    ggplot(aes(y = Value, x = NAME_ORDER, fill = SITE)) +
    geom_bar(stat = "identity", aes(fill = SITE),
               color = "black", width = 2, position = position_dodge2(preserve = "single")) +
    geom_errorbar(aes(ymax = (BAC_TURNOVER_PERC_max), ymin = (BAC_TURNOVER_PERC_min)), 
                  width = 0.3, position = position_dodge2(preserve = "single")) +
    scale_fill_manual(values = c("#de2d26", "#1c9099")) +
    facet_wrap(VARIABLE_ORDER ~ ., scales = "free", 
               strip.position = c("left"), labeller = label_parsed) +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = "")
```

```{r}
# View(biomass_rate_plot)
# tmp <- (biomass_rate_plot %>% filter(Variable == "RATE_ugCbac_pergrazer_perday" & Value > 0))
# range(tmp$Value)
# View(tmp)
# unique(biomass_rate_plot$Variable)
```


```{r, fig.width=6, fig.height=8}
# svg("prok-turnover.svg", h = 8, w = 6)
plot_grid(prok_turnover,
          prok_turnover + scale_y_continuous(limits = c(0,100)),
          ncol = 1)
# dev.off()
```

## Compare MCR data with Gorda Ridge - think about environmental parameters

Import Gorda Ridge data
```{r Import Gorda Ridge data}
gr <- read.delim("../../GordaRidgeCruise_2019/protist-gordaridge-2021/Grazing-at-GordaRidge-SKH-2021/data-input/Grazing-calc-wCarbon-results.txt")
# env_gr <- read.delim("../../GordaRidgeCruise_2019/protist-gordaridge-2021/Grazing-at-GordaRidge-SKH-2021/data-input/GR-environ-SAMPLE.txt")

temps <- read.delim("/Users/sarahhu/Desktop/Projects/GordaRidgeCruise_2019/protist-gordaridge-2019-analysis/temperature-allvents.txt")
mcr_graze <- read.delim("table-wcalc.txt")
# head(mcr_graze)
```


```{r combine data sets, tidy=FALSE}
all_vents <- mcr_graze %>%
  type.convert(as.is = TRUE) %>%
  select(SITE, NAME, SAMPLE, EXP, PROK_ml, EUK_ml, GRAZING_EFFECT_hr, GRAZING_EFFECT_hr_min, GRAZING_EFFECT_hr_max, BAC_TURNOVER_PERC, ugC_L_perday) %>% 
  rbind(gr %>%
          add_column(SITE = "Gorda Ridge") %>% 
          add_column(EUK_ml = NA) %>% 
          separate(SAMPLE, c("SAMPLE", "NAME"), sep = "-") %>% 
          select(SITE, NAME, SAMPLE, EXP = Bottle, PROK_ml = prok_avg, EUK_ml, GRAZING_EFFECT_hr = GrazingRate_hr, GRAZING_EFFECT_hr_min = GrazingRate_hr_min, GRAZING_EFFECT_hr_max = GrazingRate_hr_max, BAC_TURNOVER_PERC = Prok_turnover, ugC_L_perday = ugC_L_perday_morono)) %>% 
  left_join(temps) %>% 
  mutate(SAMPLE_TYPE = case_when(
    grepl("BSW", NAME) ~ "Background",
    grepl("Near vent BW", NAME) ~ "Background",
    grepl("Background", NAME) ~ "Background", 
    grepl("Plume", NAME) ~ "Background",
    TRUE ~ "Vent"
  ))
# View(all_vents)
# all_vents
# write_delim(all_vents, file = "grazing-cellcounts-GR_MCR.txt", delim = "\t")
```


Plot grazing rates
```{r Plot grazing rates from both sites prep df, tidy=FALSE}
allrates <- all_vents %>% 
  select(SITE, NAME, SAMPLE, EXP, SAMPLE_TYPE, starts_with("GRAZING_EFFECT_")) %>% 
  distinct() %>% 
    ggplot(aes(y = GRAZING_EFFECT_hr, x = NAME, fill = SITE, shape = SAMPLE_TYPE)) +
    geom_errorbar(aes(ymax = (GRAZING_EFFECT_hr_max), ymin = (GRAZING_EFFECT_hr_min)), 
                  width = 0.2, position = position_dodge(width = 0.4)) +
    geom_point(stat = "identity", aes(fill = SITE, shape = SAMPLE_TYPE),
               color = "black", size = 3, position = position_dodge(width = 0.4)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_manual(values = c("#de2d26", "#1c9099", "#addd8e")) +
    facet_grid(. ~ SAMPLE_TYPE, scales = "free", space = "free") +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = bquote("cells"~ml^-1~hr^-1))
```

```{r, fig.height=12, fig.width=9}
# svg("compare-all-rates.svg", h = 10, w = 7)
plot_grid(allrates,
          allrates + scale_y_continuous(limits = c(0,1000)),
          allrates + scale_y_log10(), ncol = 1)
# dev.off()
# svg("compare-all-rates-color.svg", h = 4, w = 9)
# allrates + scale_y_log10()
# dev.off()
```

Repeat grazing rate plot, but removed undetectable
```{r Plot grazing rates from both sites, tidy=FALSE}
# unique(all_vents$GRAZING_EFFECT_hr)
allrates_nonzero <- all_vents %>% 
  filter(GRAZING_EFFECT_hr > 0) %>% 
  select(SITE, NAME, SAMPLE, EXP, SAMPLE_TYPE, starts_with("GRAZING_EFFECT_")) %>% 
  distinct() %>% 
    ggplot(aes(y = GRAZING_EFFECT_hr, x = NAME, fill = SITE, shape = SAMPLE_TYPE)) +
    geom_errorbar(aes(ymax = (GRAZING_EFFECT_hr_max), ymin = (GRAZING_EFFECT_hr_min)), 
                  width = 0.2, position = position_dodge(width = 0.4)) +
    geom_point(stat = "identity", aes(fill = SITE, shape = SAMPLE_TYPE),
               color = "black", size = 3, position = position_dodge(width = 0.4)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_manual(values = c("#de2d26", "#1c9099", "#addd8e")) +
    facet_grid(. ~ SAMPLE_TYPE, scales = "free", space = "free") +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_blank())+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = bquote("cells"~ml^-1~hr^-1))
```

```{r, fig.height=4, fig.width=7}
# svg("compare-all-rates-color-nonZero.svg", h = 4, w = 7)
allrates_nonzero + scale_y_log10()
# dev.off()
```

```{r Plot cell conc and rates, fig.width=6, fig.height=10}
# svg("plot-gcellconc-grazing-log.svg", h = 10, w = 6)
# grazing_rate + scale_y_log10(limits = c(1e-1,1e5), breaks=10^(0:7))
plot_grid(conc_rate_plot_mcr(biomass_rate_plot, "PROK_ml", "PROK_sem"),
          conc_rate_plot_mcr(biomass_rate_plot, "EUK_ml", "EUK_sem"),
allrates_nonzero + scale_y_log10(), ncol = 1)
# dev.off()
```
```{r, fig.width=7, fig.height=7}
library(patchwork)
# svg("cells-per-ml.svg", h = 7, w = 7)
conc_rate_plot_mcr(biomass_rate_plot, "EUK_ml", "EUK_sem") + conc_rate_plot_mcr(biomass_rate_plot, "PROK_ml", "PROK_sem") + patchwork::plot_layout(ncol = 1) + patchwork::plot_annotation(tag_levels = "a") 
# dev.off()
```

```{r Plot grazing rates from both sites, tidy=FALSE, fig.height=4, fig.width=7}
# svg("all-grazing-rates.svg", w = 7, h = 4)
all_vents %>% 
  # filter(GRAZING_EFFECT_hr > 0) %>% 
  select(SITE, NAME, SAMPLE, EXP, SAMPLE_TYPE, starts_with("GRAZING_EFFECT_")) %>% 
  mutate(CATEGORY = case_when(
    EXP == "Bag" ~ "",
    EXP == "Exp" ~ "",
    EXP == "IGT" ~ "IGT"
  )) %>% 
  distinct() %>% 
    ggplot(aes(y = GRAZING_EFFECT_hr, x = NAME, fill = SITE, shape = SAMPLE_TYPE)) +
    geom_errorbar(aes(ymax = (GRAZING_EFFECT_hr_max), ymin = (GRAZING_EFFECT_hr_min)), 
                  width = 0.2, position = position_dodge(width = 0.4)) +
    geom_point(stat = "identity", aes(fill = SITE, shape = SAMPLE_TYPE),
               color = "black", size = 3, position = position_dodge(width = 0.4)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_manual(values = c("#addd8e", "#de2d26", "#1c9099")) +
    facet_grid(. ~ SAMPLE_TYPE + CATEGORY, scales = "free", space = "free") +
    scale_y_log10() +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_text(color="black", size = 8, vjust = 0.5))+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = bquote("cells"~ml^-1~hr^-1))
# dev.off()
```

```{r,fig.height=4, fig.width=8}
# svg("all-grazing-rates.svg", w = 7, h = 4)
euk_temp <- all_vents %>%
# prok_temp <- all_vents %>%
  # filter(GRAZING_EFFECT_hr > 0) %>% 
  select(SITE, NAME, SAMPLE, EXP, SAMPLE_TYPE, EUK_ml, Highest.Temp) %>% 
  mutate(CATEGORY = case_when(
    EXP == "Bag" ~ "",
    EXP == "Exp" ~ "",
    EXP == "IGT" ~ "IGT"
  )) %>% 
  distinct() %>% 
  pivot_longer(cols = ends_with("_ml")) %>% 
    ggplot(aes(y = name, x = NAME, fill = Highest.Temp, size = value)) +
    geom_jitter(stat = "identity", aes(fill = Highest.Temp, size = value),
               color = "black", shape = 21, position = position_dodge(width = 0.4)) +
    scale_size_continuous(range = c(3,12)) +
    scale_fill_continuous(low = "#fed976", high = "#e31a1c") +
    # scale_fill_continuous(values = c("#fed976", "#fd8d3c", "#e31a1c", "#b10026")) +
    facet_grid(name ~ SAMPLE_TYPE + CATEGORY, scales = "free", space = "free") +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"), 
          axis.text.x = element_text(color="black", size = 11, 
                                     angle = 45, hjust = 1, vjust = 1), 
          axis.text.y = element_text(color="black", size = 11),
          axis.title =element_text(color="black", size = 11),
          axis.ticks = element_line(),
          legend.title = element_blank(),
          strip.placement = "outside",
          strip.text.y = element_text(color="black", size = 11),
          strip.text.x = element_text(color="black", size = 8, vjust = 0.5))+
    guides(fill = guide_legend(override.aes = list(shape = c(21))),
           shape = guide_legend(override.aes = list(fill = "black"))) +
    labs(x = "", y = bquote("cells"~ml^-1~hr^-1))

# svg("euk_temp.svg", w = 8, h = 4)
# euk_temp
# dev.off()
# 
# svg("prok_temp.svg", w = 8, h = 4)
# prok_temp
# dev.off()
```


## Run regression analysis with MCR and GR data
```{r Import meta data again}
metadata <- read.delim("input-data/flp-exp-metadata-compiled.txt")
# head(metadata)
# temps
# all_vents
```

Linear regression with both Gorda Ridge and MCR data
```{r perform lm}
library(broom)
# ?pivot_longer
# e	IGT
# head(all_vents)
regression_input <- all_vents %>% 
  filter(!(SAMPLE == "Piccard-Shrimpocalypse" & EXP == "IGT")) %>% 
  filter(!is.na(Highest.Temp)) %>% 
    select(SITE, NAME, SAMPLE, SAMPLE_TYPE, EXP, PROK_ml, EUK_ml, GRAZING_EFFECT_hr, BAC_TURNOVER_PERC, ugC_L_perday, TEMP = Highest.Temp) %>% 
  mutate(PROK_EUK_RATIO = (PROK_ml/EUK_ml)) %>% 
  pivot_longer(cols = c(GRAZING_EFFECT_hr, BAC_TURNOVER_PERC, ugC_L_perday), names_to = "RATE", values_to = "RATE_VALUE") %>% 
  pivot_longer(cols = c(PROK_ml, EUK_ml, PROK_EUK_RATIO, TEMP), names_to = "PARAMS", values_to = "PARAMS_VALUE") %>% 
  data.frame

regression_tmp <- regression_input %>% 
  # Set up the linear regression
  group_by(RATE, PARAMS) %>% 
  nest(-RATE, -PARAMS) %>% 
  mutate(lm_fit = map(data, ~lm(RATE_VALUE ~ PARAMS_VALUE, data = .)), 
    tidied = map(lm_fit, tidy)) %>% 
  unnest(tidied) %>% 
  select(RATE, PARAMS, 
    term, estimate) %>% 
  pivot_wider(names_from = term, values_from = estimate) %>% 
  select(everything(), SLOPE = PARAMS_VALUE) %>%
  data.frame

regression_results <- regression_input %>% 
  group_by(RATE, PARAMS) %>% 
  nest(-RATE, -PARAMS) %>% 
  mutate(lm_fit = map(data, ~lm(RATE_VALUE ~ PARAMS_VALUE, data = .)),
    glanced = map(lm_fit, glance)) %>% 
  unnest(glanced) %>% 
  select(RATE, PARAMS, r.squared, adj.r.squared) %>% 
  right_join(regression_tmp) %>%
  right_join(regression_input) %>%
  data.frame

# head(regression_results)
```

Plot regression results
```{r Plot results from lm, tidy=FALSE, fig.height=7, fig.width=15}
regression_results %>% 
  # filter(RATE == "GRAZING_EFFECT_hr") %>%
  # filter(PARAMS == "TEMP") %>% 
  ggplot(aes(x = PARAMS_VALUE, y = RATE_VALUE, shape = SAMPLE_TYPE, fill = SITE)) +
    geom_abline(aes(slope = SLOPE, intercept = `X.Intercept.`), color = "black", linetype = "dashed", size = 0.5) +
    geom_point(color = "black", aes(shape = SAMPLE_TYPE, fill = SITE)) +
    scale_shape_manual(values = c(21, 24)) +
    scale_fill_manual(values = c("#476AA7","#7299CE", "#A2937A")) +
    facet_wrap(PARAMS ~ RATE + round(r.squared, 3), scales = "free", ncol = 5,
             strip.position = "bottom", labeller = label_parsed) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text = element_text(color = "black", size = 10),
    axis.title = element_text(color = "black", size = 10),
    legend.title = element_blank()) # +
  # labs(y = bquote("Cells "~mL^-1 ~hr^-1), x = "Temperature (C)")
```

_NEXT STEP_ = get more biogeochem data?


# Parameter comparions to plot
```{r}
head(regression_results)
unique(regression_results$PARAMS)
```

Plot temperature by euk:prok ratio? individual? other things?


# Prediction of MCR data with parameters

From Vaque et al. 1994 paper equation (1):

> log(GT) = -3.21 + 0.99 log (HNF) + 0.028 (T) + 0.55 log(BAC)

*GT* = grazing rate (cells ml-1 hr-1)
*HNF* = heterotrophic nanoflagellates (cells ml-1) T = temperature (C)
*BAC* = prokaryote abundance (cells ml-1)


Start with non-zero grazing rate values, etc. 
Where... 
*GT* == Grazing effect hr
*HNF* == Euk_ml
*BAC* == PROK_ml
*T* == highest temp

We only have these for MCR data.. can include GR for the "predicting euk_ml"

## Predicted parameters
```{r Calculate different predicted variables}
# head(all_vents)
allvent_wpredicted <- all_vents %>% 
  select(SITE, NAME, SAMPLE, EXP, PROK_ml, EUK_ml, GRAZING_EFFECT_hr, Highest.Temp) %>% 
  group_by(SITE, NAME, SAMPLE, EXP, PROK_ml, EUK_ml, GRAZING_EFFECT_hr) %>% 
  summarise(TEMP = mean(Highest.Temp)) %>% 
  distinct() %>% 
  mutate(PREDICTED_TEMP = (((log(GRAZING_EFFECT_hr)) + 3.21 - (0.99*log(EUK_ml)) - (0.55*log(PROK_ml))) / 0.028),
         PREDICTED_GRAZING_EFFECT_hr = (10^(-3.21 + (0.99*log(EUK_ml)) + (0.028*TEMP) + (0.55*(log(PROK_ml))))),
         PREDICTED_EUK = (10^(((log(GRAZING_EFFECT_hr)) + 3.21 - (0.55*log(PROK_ml)) - (0.028*TEMP))/0.99)),
         PREDICTED_PROK = (10^(((log(GRAZING_EFFECT_hr)) + 3.21 - (0.99*log(EUK_ml)) - (0.028*TEMP))/0.55)))

# View(allvent_wpredicted)
```

# Session info
```{r END session information}
sessionInfo()
```

